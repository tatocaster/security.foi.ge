# Variables
$repoUrl = "https://github.com/foige/security.foi.ge/archive/refs/heads/main.zip"
$rand = Get-Random
$tempBase = $env:TEMP
$destinationFolder = "foi_$rand"
$destination = Join-Path -Path $tempBase -ChildPath $destinationFolder
$zipFile = Join-Path -Path $destination -ChildPath "$destinationFolder.zip"
$extractedFolderName = "security.foi.ge-main"
$psRelativePath = "docs\policies\files\windows"
$fullPsPath = Join-Path -Path $destination -ChildPath "$extractedFolderName\$psRelativePath"
$psFile = "foi_tools.ps1"

# Create the destination directory if it does not exist
if (-Not (Test-Path $destination)) {
    New-Item -ItemType Directory -Force -Path $destination
}

# Download the ZIP file
Invoke-WebRequest -Uri $repoUrl -OutFile $zipFile

# Verify that the ZIP file exists and has non-zero size
while (-Not (Test-Path $zipFile) -or (Get-Item $zipFile).Length -eq 0) {
    Start-Sleep -Seconds 2
    Write-Output "Waiting for the ZIP file to be ready..."
}

# Extract the ZIP file
try {
    Expand-Archive -Path $zipFile -DestinationPath $destination -Force
} catch {
    Write-Output "Failed to expand the ZIP file: $_"
    Read-Host "Press Enter to exit"
    exit
}

# Execute the PowerShell script with elevated privileges
$scriptPath = Join-Path -Path $fullPsPath -ChildPath $psFile
if (Test-Path $scriptPath) {
    Start-Process powershell.exe -ArgumentList "-NoExit -NoLogo -NoProfile -ExecutionPolicy Bypass -Command `"[Console]::BackgroundColor = 'Black'; [Console]::ForegroundColor = 'White'; [Console]::Clear(); cd '$fullPsPath'; & '$scriptPath'`"" -Verb RunAs
    Write-Output "PowerShell script executed from: $fullPsPath"
    Remove-Item $zipFile -Force
    exit
} else {
    Write-Output "No PowerShell script found at $scriptPath"
    Read-Host "Press Enter to exit"
}
